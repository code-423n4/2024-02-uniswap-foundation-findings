# Analysis Report

## 1. Overview

The system composed from a set of contracts designed to facilitate Uniswap V3 protocol fee collection and distribution via UNI staking. It allows Uniswap Governance to enable and manage protocol fees on Uniswap V3 pools while distributing the generated fees to UNI token holders who choose to delegate and stake their tokens. The repository contains contracts that implement the staking mechanics and reward distribution mechanisms convert fees in disparate tokens across many pools into discrete chunks of rewards denominated in a single token, which can be distributed to stakers.

### 1.1 Functionality

The system consists of two core contracts:

- **V3FactoryOwner:** This contract acts as the owner of the Uniswap V3 Factory and manages the configuration and collection of protocol pool fees.
- **UniStaker:** This contract manages the distribution of rewards to stakers based on their staked UNI tokens while they are delegating their voting power by a `DelegationSurrogate` contract address

## 2. Audit Approach

Time spent: ~50 hours

Our audit approach involves reviewing the contracts' codebase, assessing its adherence to best practices, identifying potential security vulnerabilities, and conducting scenario-based testing to validate contract functionality and behavior under various conditions.

During the audit, we collected scenario cases based on different use cases and potential edge cases identified within the project scope. These scenarios encompassed a wide range of interactions with the contracts, including staking and withdrawing tokens, staking more tokens, altering reward beneficiaries, claiming rewards, changing delegations, and claiming protocol fees... By systematically exploring these scenarios, we aimed to evaluate the contracts' robustness, resilience, and compliance with the specified requirements.

The test suites provided by the project played a crucial role in facilitating scenario-based testing. These test suites enabled us to execute predefined test cases, validate contract behavior, and identify any discrepancies or unexpected outcomes. Moreover, the project test suites helped us understand ambiguous areas within the codebase and expedited the process of writing additional test cases to cover edge cases and corner scenarios.

Overall, scenario-based testing, coupled with the comprehensive test suites, served as an effective mechanism for validating contract functionality, uncovering potential issues, and ensuring the overall security and reliability of the system.

## 3. Mechanism Review

### 3.1 V3FactoryOwner

The V3FactoryOwner contract serves as the owner of the Uniswap V3 Factory and facilitates the configuration and collection of protocol pool fees.

#### 3.1.1 Functionality

- Allows Uniswap Governance to set fees on specific pools via permissioned passthrough methods.
- Allows Uniswap Governance to set the payout token amount required to claim fees from a pool, which's shared between all pools.
- Facilitates the collection of protocol fees on fee-enabled pools by interesting race condition mechanism.
- Distributes fees to stakers through the UniStaker contract.

#### 3.1.2 Recommendations

##### Event Parameter Name Correction

a typo was identified in the event parameter names of the `AdminSet` event. The parameter `oldAmin` should be corrected to `oldAdmin` for consistency and accuracy. This correction ensures clarity and coherence in event logs, facilitating better understanding and interpretation of contract events by developers and users alike.

```solidity
src/V3FactoryOwner.sol:
  47:   /// @notice Emitted when the existing admin designates a new address as the admin.
  48:   event AdminSet(address indexed oldAmin, address indexed newAdmin);
```

### 3.2 UniStaker

The purpose of UniStaker is to create a decentralized mechanism for distributing protocol fees generated by Uniswap V3 pools to UNI token holders who stake their tokens. By staking UNI tokens, holders can earn a share of the fees accumulated in the system.

#### 3.2.1 Functionality

- Manages the distribution of rewards to stakers.
- Allows users to delegate voting power to specific addresses.
- Allows users to specify a beneficiary address to receive staking rewards.
- Tracks stake on a per-deposit basis, enabling users to manage multiple deposits independently.
- Supports adding multiple reward sources in the future.

#### 3.2.2 Usability Enhancement

If users or other contracts need to interact with UniStaker and track multiple deposits associated with a user, the absence of a method to retrieve deposit identifiers could indeed pose usability challenges. Without a straightforward way to retrieve deposit IDs, users or contracts would need to keep track of these identifiers themselves, potentially leading to errors or inefficiencies in managing their staking activities.

While having multiple deposits for a user might not inherently be an issue, the lack of a method to retrieve deposit IDs could make it challenging to distinguish between different deposits or perform operations on specific deposits if needed.

To address this, it could be beneficial to add a method in UniStaker that allows users or contracts to retrieve deposit IDs associated with a particular user address. This would enhance the usability and flexibility of the contract, facilitating smoother interactions and better management of staking activities for users and integrators.

#### 3.2.3 Recommendations

##### Addressing Reward Token Loss Due to Lack of Stakers

It is recommended to address the vulnerability submitted as that leads to reward token loss when there are no stakers present during a reward duration. For detailed information about this vulnerability, its impact, proof of concept, and mitigation steps, refer to the corresponding report provided separately by me named; [UniStaker Reward Loss When No Stakers at Current Reward Duration (Partly or Fully)].

##### Parameter Names in EIP-712 Typehash

It is recommended to address the inconsistencies between the parameter names in the EIP-712 typehash constants and their corresponding function signatures. For detailed information about this issue, refer to the corresponding report provided separately as; [Mismatched Parameter Names in EIP-712 Typehash].

##### Addition of Deposit ID Retrieval Method

Consider adding a method in UniStaker that allows users or contracts to retrieve deposit IDs associated with a particular user address. This enhancement would improve usability and flexibility, enabling smoother interactions and better management of staking activities for users and integrators.

##### Public Getters for Contract Variables

In the `DelegationSurrogate` contract, public getter functions can be useful for the `token` and `delegatee` variables. By exposing these variables to external visibility, developers and users can query the contract state to retrieve information about the governance token and the designated delegatee address. This enhancement improves transparency and accessibility, allowing for easier integration with other smart contracts and interfaces.

## 4. Architecture Recommendations

### 4.1 Refactoring for Modularity and Clarity

Consider refactoring the contracts to improve clarity, reduce complexity, and enhance maintainability, especially in areas where interfaces can be utilized effectively. By employing interfaces, contract dependencies can be abstracted, enabling more modular and interchangeable components. This approach facilitates easier auditing, testing, and upgrades, as well as promoting code reuse and scalability. Moreover, using interfaces fosters adherence to best practices and standards, enhancing interoperability and future compatibility with external systems and protocols.

### 4.2 Enhancement of User Interaction and Data Accessibility

Introduce methods in the UniStaker contract to retrieve deposit IDs associated with specific user addresses. This enhancement enhances user interaction and data accessibility, providing users and integrators with the necessary tools to manage their staking activities more efficiently. By enabling the retrieval of deposit IDs, users can easily track and manage multiple deposits, improving the overall usability and flexibility of the staking mechanism.

#### 4.3 Ensuring Transparency and Integration Support

Implement missing public getter functions for essential contract variables, such as token addresses and delegatee information. These public getters enhance transparency and integration support, allowing external contracts and interfaces to query the contract state accurately. By exposing critical information to external visibility, developers and users can interact with the system more effectively, fostering trust, interoperability, and ecosystem growth.

## 5. Centralization risks

The project entails centralization risks primarily associated with its admin set functionality, notably the capacity to designate a new admin address in a single step without additional safeguards. This streamlined approach, while facilitating administrative tasks, amplifies the likelihood of accidental or unauthorized modifications, potentially resulting in mismanagement of protocol resources or loss of funds. While these risks may not directly impact core functionalities, they could impede critical administrative operations, such as adding or removing reward sources. Implementing additional safeguards, multi-step verification processes, or access controls is imperative to mitigate these centralization risks and bolster system security and stability. Moreover, enhancing transparency, accountability, and auditability of admin-related actions can reduce the likelihood of errors, unauthorized changes, or malicious activities, fostering decentralization, trust, and resilience within the ecosystem.

## 6. Systemic Risks

### 6.1 Unrecoverable Reward Tokens

The actual risk posed by the issue of unrecoverable reward tokens (described in **3.2.4**) is the potential loss of value within the protocol ecosystem. When reward tokens become unclaimable and irretrievable due to factors such as the absence of stakers during reward durations, it directly impacts the incentives for participants and undermines the protocol's economic viability.

This risk extends beyond the immediate loss of tokens; it erodes trust in the protocol and diminishes its attractiveness to users and investors. Moreover, it can lead to negative publicity and reputational damage, further deterring adoption and investment in the ecosystem.

Therefore, the actual risk lies in the systemic implications of unrecoverable reward tokens, which include decreased user engagement, diminished protocol utility, and compromised long-term sustainability.

## 7. Conclusion

In conclusion, the audit of the Uniswap V3 protocol fee collection and distribution system has been comprehensive and insightful. Throughout the audit process, we meticulously reviewed the contracts' codebase, identified potential vulnerabilities, and provided recommendations to enhance security, usability, and transparency. The project demonstrates a robust and logical mechanism for facilitating protocol fee distribution while ensuring the security and integrity of the system.

I am delighted to have had the opportunity to audit this project, as it provided valuable insights into smart contract auditing practices and the intricacies of decentralized finance protocols. The comprehensive test suites and well-structured codebase facilitated a thorough assessment of the system's functionality and security features. It was a gratifying experience to delve into the project's logic and architecture, and I am pleased to report that the system exhibits a high level of security in every aspect.

Moreover, I thoroughly enjoyed the challenge of testing the system's resilience and attempting to identify potential vulnerabilities. The project's robust design and rigorous testing procedures made it a stimulating and rewarding experience. I am particularly impressed by the project team's commitment to security and their proactive approach to addressing potential risks.

Overall, auditing this project has been a rewarding journey, and I am grateful for the opportunity to contribute to its security and reliability. I look forward to seeing the project evolve and thrive in the decentralized finance ecosystem, and I am confident that it will continue to uphold the highest standards of security and integrity.

### Time spent:
50 hours